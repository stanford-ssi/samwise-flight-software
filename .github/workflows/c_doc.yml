name: Claude Documentation

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@c_docs')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@c_docs'))
      ) && (
        github.actor == 'devYaoYH' ||
        github.actor == 'carter-cochran'
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      deploy:
      # ... other steps to deploy the code
      - name: Add comment to PR
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const name = '${{ github.workflow   }}';
            const url = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';
            const success = '${{ job.status }}' === 'success';
            const body = `${name}: ${success ? 'succeeded ✅' : 'failed ❌'}\n${url}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
      - uses: actions/checkout@v4
        with: { fetch-depth: 5 }

      - name: Run Claude Docs
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@c_docs"     # distinct from @claude
          additional_permissions: |
            actions: read

          # Optional: specify model (uncomment to pin)
          # model: "claude-4-5-haiku-latest"

          # Keep the instructions static—remove undefined interpolation
          custom_instructions: |
            Tasks:
            1) If the command includes "docs" or "doc":
              - Inspect the PR's diff to detect all user-visible changes (APIs, CLI flags, behavior, etc.).
              - **Goal: Generate Brief Update Documentation.** For every file or module affected by the PR.
                - If a relevant documentation file exists, propose an update to reflect the changes.
                - If new user-facing code is added without existing documentation, propose the creation of a **new, complete README equivalent paragraph/section** detailing its purpose, usage, and examples.
              - Tone: factual, concise.

            2) If the command includes "changelog" or "change log":
              - write a faux-CHANGELOG.md per "Keep a Changelog" (Added/Changed/Fixed/etc.) in the comments in terse bullets.
              - Summarize PR's user-facing changes in terse bullets (1–2 lines), including the PR number in parentheses when available, and @contributors.
              - If no user-visible changes, add a note under "Changed" or skip.

            Output Policy (Strict):
            - Post a PR comment containing ONLY a summary paragraph followed by a single ```diff fence.
