name: Claude Documentation

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    # Fire on review comments, reviews, and regular PR comments that include the trigger phrase
    if: >
      (
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '/claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '/claude')) ||
        (github.event_name == 'issue_comment' && github.event.issue.pull_request != '' && contains(github.event.comment.body, '/claude'))
      )
      && (
        github.actor == 'devYaoYH' ||
        github.actor == 'carter-cochran'
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write   # allow commenting on PRs
      issues: write          # allow commenting when event is issue_comment
      id-token: write
      actions: read          # for CI status reading

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 5

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Let the action recognize /claude ... (not @claude)
          trigger_phrase: "/claude"

          # This lets Claude read CI results on PRs
          additional_permissions: |
            actions: read

          # Optional: specify model (uncomment to pin)
          # model: "claude-4-5-haiku-latest"

          # Keep the instructions static—remove undefined interpolation
          custom_instructions: |
            Tasks:
            1) If the command includes "docs" or "doc":
              - Inspect the PR's diff to detect all user-visible changes (APIs, CLI flags, behavior, etc.).
              - **Goal: Generate Brief Update Documentation.** For every file or module affected by the PR.
                - If a relevant documentation file exists, propose an update to reflect the changes.
                - If new user-facing code is added without existing documentation, propose the creation of a **new, complete README equivalent paragraph/section** detailing its purpose, usage, and examples.
              - Tone: factual, concise.

            2) If the command includes "changelog" or "change log":
              - write a faux-CHANGELOG.md per "Keep a Changelog" (Added/Changed/Fixed/etc.) in the comments in terse bullets.
              - Summarize PR's user-facing changes in terse bullets (1–2 lines), including the PR number in parentheses when available, and @contributors.
              - If no user-visible changes, add a note under "Changed" or skip.

            Output Policy (Strict):
            - Post a PR comment containing ONLY a summary paragraph followed by a single ```diff fence.
