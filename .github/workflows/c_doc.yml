name: claude (docs + changelog on command)

on:
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: claude-docs-changelog-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  run_on_command:
    # Only run if:
    # 1. The actor is a trusted user.
    # 2. The comment/review contains the specific command '@claude docs' OR '@claude changelog'.
    if: |
      contains(fromJSON('["devYaoYH", "carter-cochran"]'), github.actor) &&
      (
        contains(github.event.comment.body || github.event.review.body || '', '@claude docs') ||
        contains(github.event.comment.body || github.event.review.body || '', '@claude changelog')
      )
    runs-on: ubuntu-latest

    env:
      # Globs defining which files Claude is allowed to modify/update
      README_GLOBS: "README.md,**/README.md,docs/**/*.md,CHANGELOG.md"
      MAX_OUTPUT_TOKENS: "900"

    steps:
      - name: Get PR context
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. Safely derive PR number from issue_comment, pull_request_review, or pull_request_review_comment events.
          pr_num=${{ github.event.issue.number || github.event.pull_request.number || github.event.pull_request_review_comment.pull_request.number }}
          if [ -z "$pr_num" ]; then
            echo "::error::Could not determine PR number for this event. Skipping."
            exit 1
          fi

          pr_json=$(gh api repos/${{ github.repository }}/pulls/$pr_num)
          
          echo "number=$pr_num" >> $GITHUB_OUTPUT
          echo "head_sha=$(jq -r '.head.sha' <<< "$pr_json")" >> $GITHUB_OUTPUT
          echo "base_ref=$(jq -r '.base.ref' <<< "$pr_json")" >> $GITHUB_OUTPUT
          # Determine if the PR is from a fork, which dictates if we can push directly.
          echo "can_push=$(jq -r 'if .head.repo.owner.login == .base.repo.owner.login then "true" else "false" end' <<< "$pr_json")" >> $GITHUB_OUTPUT
          
          body="${{ github.event.comment.body || github.event.review.body }}"
          
          # 2. Model selection: Use Sonnet only if '@claude sonnet' is explicitly in the command.
          if grep -iq '@claude sonnet' <<< "$body"; then
            model='claude-3-5-sonnet-latest'
          else
            model='claude-3-5-haiku-latest'
          fi
          echo "model=$model" >> $GITHUB_OUTPUT

      - name: Checkout PR HEAD
        uses: actions/checkout@v4
        with:
          # Checkout the PR's head commit for accurate diffing and file modifications
          fetch-depth: 2
          ref: ${{ steps.pr.outputs.head_sha }}

      - name: Get changed documentation files
        id: files
        run: |
          # Fetch the base branch to perform an accurate diff
          git fetch origin ${{ steps.pr.outputs.base_ref }}
          
          # Get a list of changed files between PR head and base
          changed_files=$(git diff --name-only origin/${{ steps.pr.outputs.base_ref }}..${{ steps.pr.outputs.head_sha }})
          
          # Filter changed files against the defined globs and save the list
          IFS=',' read -ra globs <<< "${{ env.README_GLOBS }}"
          filtered_files=()
          while IFS= read -r file; do
            for glob in "${globs[@]}"; do
              if [[ "$file" == $glob ]]; then
                filtered_files+=("$file")
                break
              fi
            done
          done <<< "$changed_files"
          
          printf "%s\n" "${filtered_files[@]}" > filtered_files.txt
          echo "count=${#filtered_files[@]}" >> $GITHUB_OUTPUT

      - name: Run Claude for docs/changelog
        if: steps.files.outputs.count != '0'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ github.token }}
          pr_number: ${{ steps.pr.outputs.number }}
          trigger_phrase: "@claude"
          model: ${{ steps.pr.outputs.model }}
          
          # Custom instructions that guide Claude's behavior for this specific task
          custom_instructions: |
            You are the repository's Documentation & Changelog Maintainer.

            Context:
            - Triggered from PR #${{ steps.pr.outputs.number }} in ${{ github.repository }}.
            - The original command was: "${{ github.event.comment.body || github.event.review.body }}"
            - Repo root and PR diff are checked out in the workspace.

            - Allowed Files for Modification (derived from PR diff & globs):
              ---
              {{ALLOWED_FILES}}
              ---

            Capabilities:
            - If can_push=${{ steps.pr.outputs.can_push }} (from same repo): you MAY modify only the allowed files and commit directly to the PR branch.
            - If can_push=false (from fork): DO NOT modify files; instead, post a PR comment with a single fenced unified diff (```diff ...```).

            Tasks:
            1) If the command includes "docs" or "doc":
              - Inspect the PR's diff to detect user-visible changes (APIs, CLI flags, behavior).
              - Update existing READMEs under the globs: "${{ env.README_GLOBS }}".
              - If a changed top-level package/module is missing a README, create one with purpose, install/usage, and updated examples.
              - Tone: factual, concise.

            2) If the command includes "changelog" or "change log":
              - Update or create CHANGELOG.md per "Keep a Changelog" (Added/Changed/Fixed/etc.).
              - Summarize PR's user-facing changes in terse bullets (1â€“2 lines), including "(#${{ steps.pr.outputs.number }})" and @contributors.
              - If no user-visible changes, add a note under "Changed" or skip.

            Safety & Style:
            - Keep edits minimal and surgical; preserve the author's voice where possible.
            - Do not touch files outside the ALLOWED_FILES list.
            - Preserve markdown formatting, links, and table structures.

            Output & Commit Policy (Strict):
            - If can_push=true: Commit with the appropriate prefix ("docs:" or "chore(changelog):").
            - If can_push=false: Post a PR comment containing ONLY a summary paragraph followed by a single ```diff fence.

          extra_context: |
            ALLOWED_FILES<<EOF
            $(cat filtered_files.txt)
            EOF

          claude_args: |
            --maxOutputTokens "${{ env.MAX_OUTPUT_TOKENS }}"
            # Tool to allow Claude to post inline comments on PRs/Issues if needed (e.g., if it can't commit)
            --allowedTools "mcp__github_inline_comment__create_inline_comment"

      - name: No documentation changes detected
        if: steps.files.outputs.count == '0'
        run: echo "No files matched globs or no relevant files were changed; skipping Claude run."
